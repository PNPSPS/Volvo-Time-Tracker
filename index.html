<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volvo Service Tracker</title>
    
    <!-- 1. โหลดเครื่องมือที่จำเป็น (React, Tailwind, Firebase) จาก CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat Library (เพื่อให้ทำงานในไฟล์เดียวได้ง่าย) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- 2. ส่วนของโค้ดโปรแกรม -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (SVG) เพื่อไม่ต้องลงโปรแกรมเพิ่ม ---
        const Icons = {
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            BarChart3: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Wifi: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        };

        // --- Main Component ---
        const TechnicianTimeTracker = () => {
            const [isConfigured, setIsConfigured] = useState(false);
            const [configInput, setConfigInput] = useState('');
            const [user, setUser] = useState(null);
            const [technicians, setTechnicians] = useState([]);
            const [workLogs, setWorkLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const [selectedTechId, setSelectedTechId] = useState(null);
            const [partnerId, setPartnerId] = useState('');
            const [jobInput, setJobInput] = useState('');
            const [stdTimeInput, setStdTimeInput] = useState('');
            const [activeTab, setActiveTab] = useState('tracker');
            const [currentTime, setCurrentTime] = useState(new Date());

            const appId = 'volvo-service-tracker-web';

            // --- 1. Init System ---
            useEffect(() => {
                const savedConfig = localStorage.getItem('volvo_firebase_config');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        if (!firebase.apps.length) {
                            firebase.initializeApp(config);
                        }
                        setIsConfigured(true);
                        handleAuth();
                    } catch (e) {
                        console.error("Config Error", e);
                        setLoading(false);
                    }
                } else {
                    setLoading(false);
                }
            }, []);

            // --- 2. Auth ---
            const handleAuth = () => {
                setLoading(true);
                firebase.auth().signInAnonymously().catch(console.error);
                firebase.auth().onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
            };

            // --- 3. Realtime Sync ---
            useEffect(() => {
                if (!user || !isConfigured) return;
                const db = firebase.firestore();

                // Techs
                const unsubTechs = db.collection('artifacts').doc(appId).collection('technicians')
                    .onSnapshot(snap => {
                        const loaded = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if(loaded.length === 0) seedDefaultTechnicians();
                        else setTechnicians(loaded.sort((a,b) => parseInt(a.id) - parseInt(b.id)));
                    });

                // Logs
                const unsubLogs = db.collection('artifacts').doc(appId).collection('work_logs')
                    .onSnapshot(snap => {
                        const loaded = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        setWorkLogs(loaded.sort((a,b) => b.createdAt - a.createdAt));
                    });

                return () => { unsubTechs(); unsubLogs(); };
            }, [user, isConfigured]);

             useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // --- Actions ---
            const handleSaveConfig = () => {
                try {
                    JSON.parse(configInput);
                    localStorage.setItem('volvo_firebase_config', configInput);
                    window.location.reload();
                } catch(e) { alert("Config ไม่ถูกต้อง"); }
            };

             const handleResetConfig = () => {
                if(confirm("รีเซ็ตการตั้งค่า?")) {
                    localStorage.removeItem('volvo_firebase_config');
                    window.location.reload();
                }
            };

            const seedDefaultTechnicians = () => {
                const db = firebase.firestore();
                const batch = db.batch();
                const defaultTechs = [
                    { id: '1', name: 'PST Thanawut' },
                    { id: '2', name: 'PST Naroot' },
                    { id: '3', name: 'PST Chayaphon' },
                    { id: '4', name: 'PST Ponrphot' }
                ];
                defaultTechs.forEach(t => {
                    const ref = db.collection('artifacts').doc(appId).collection('technicians').doc(t.id);
                    batch.set(ref, { ...t, status: 'idle', currentJob: '', startTime: null, stdTime: 0 });
                });
                batch.commit();
            };

            const handleStartJob = () => {
                if (!jobInput.trim()) return;
                const db = firebase.firestore();
                const batch = db.batch();
                
                let std = parseFloat(stdTimeInput) || 0;
                const isPair = partnerId !== '';
                const stdPerPerson = isPair ? std/2 : std;
                const start = new Date().toISOString();

                [selectedTechId, partnerId].filter(Boolean).forEach(id => {
                    const ref = db.collection('artifacts').doc(appId).collection('technicians').doc(id);
                    batch.update(ref, { status: 'working', currentJob: jobInput, startTime: start, stdTime: stdPerPerson, isPair });
                });
                batch.commit();
                setJobInput(''); setStdTimeInput(''); setPartnerId('');
            };

            const handleStopJob = () => {
                const tech = technicians.find(t => t.id === selectedTechId);
                const db = firebase.firestore();
                const end = new Date().toISOString();
                const start = new Date(tech.startTime);
                const diffMs = new Date(end) - start;
                const mins = Math.floor(diffMs / 60000);
                const stdMins = tech.stdTime * 60;
                
                let eff = 0;
                if(mins > 0 && stdMins > 0) eff = Math.round((stdMins/mins)*100);
                else if(stdMins > 0) eff = 100;

                const hrs = Math.floor(mins/60);
                const mn = mins%60;
                const durText = `${hrs} ชม. ${mn} นาที`;

                db.collection('artifacts').doc(appId).collection('work_logs').add({
                    techId: tech.id, techName: tech.name, jobNo: tech.currentJob,
                    startTime: tech.startTime, endTime: end, durationText: durText,
                    actualMinutes: mins, stdTime: tech.stdTime, efficiency: eff,
                    date: new Date().toLocaleDateString('th-TH'), createdAt: Date.now()
                });

                db.collection('artifacts').doc(appId).collection('technicians').doc(tech.id).update({
                    status: 'idle', currentJob: '', startTime: null, stdTime: 0, isPair: false
                });
            };

             const clearLogs = () => {
                if(confirm("ลบประวัติทั้งหมด?")) {
                    const db = firebase.firestore();
                    workLogs.forEach(l => db.collection('artifacts').doc(appId).collection('work_logs').doc(l.id).delete());
                }
            };

            // --- Render ---
            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                            <h2 className="text-2xl font-bold text-blue-800 mb-4 text-center">System Setup</h2>
                            <textarea 
                                className="w-full h-32 p-3 border rounded mb-4 text-sm font-mono" 
                                placeholder='วาง Firebase Config ที่นี่...'
                                value={configInput} onChange={e => setConfigInput(e.target.value)}
                            ></textarea>
                            <button onClick={handleSaveConfig} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">บันทึก</button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="p-10 text-center">กำลังเชื่อมต่อ...</div>;

            const selectedTech = technicians.find(t => t.id === selectedTechId);
            const idleTechs = technicians.filter(t => t.status === 'idle' && t.id !== selectedTechId);

            // Time Helper
            const getElapsed = (start) => {
                if(!start) return "00:00:00";
                const diff = currentTime - new Date(start);
                const h = Math.floor(diff/3600000).toString().padStart(2,'0');
                const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                return `${h}:${m}:${s}`;
            };

            return (
                <div className="max-w-4xl mx-auto p-4 pb-24">
                     <header className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
                        <div>
                            <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <span className="w-8 h-8 bg-blue-700 rounded-full flex items-center justify-center text-white">V</span>
                                Volvo Tracker
                            </h1>
                            <p className="text-xs text-green-600 flex items-center gap-1"><Icons.Wifi/> Online</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="text-right hidden sm:block">
                                <div className="text-lg font-mono font-medium text-blue-700">{currentTime.toLocaleTimeString('th-TH')}</div>
                            </div>
                            <button onClick={handleResetConfig} className="text-slate-300 hover:text-slate-600"><Icons.Settings/></button>
                        </div>
                    </header>

                    <div className="flex gap-2 mb-6">
                        {['tracker', 'history', 'dashboard'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} 
                                className={`flex-1 py-3 rounded-lg text-sm font-bold capitalize flex items-center justify-center gap-2 ${activeTab === tab ? 'bg-blue-50 text-blue-700' : 'bg-white text-slate-500'}`}>
                                {tab === 'tracker' && <Icons.Clock/>}
                                {tab === 'history' && <Icons.History/>}
                                {tab === 'dashboard' && <Icons.BarChart3/>}
                                {tab}
                            </button>
                        ))}
                    </div>

                    {activeTab === 'tracker' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-3">
                                {technicians.map(tech => (
                                    <button key={tech.id} onClick={() => { setSelectedTechId(tech.id); setJobInput(''); setStdTimeInput(''); setPartnerId(''); }}
                                        className={`w-full p-4 rounded-xl border text-left transition-all relative ${selectedTechId === tech.id ? 'border-blue-500 ring-2 ring-blue-100 bg-white' : 'border-white bg-white hover:border-blue-200'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${tech.status === 'working' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                                                    {tech.name.split(' ')[1]?.charAt(0)}
                                                </div>
                                                <div>
                                                    <div className="font-bold flex items-center gap-1">{tech.name} {tech.isPair && <span className="text-blue-500"><Icons.Users/></span>}</div>
                                                    <div className={`text-xs px-2 rounded-full inline-block ${tech.status === 'working' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>{tech.status}</div>
                                                </div>
                                            </div>
                                            {tech.status === 'working' && <div className="font-mono text-blue-600 font-bold">{getElapsed(tech.startTime)}</div>}
                                        </div>
                                    </button>
                                ))}
                            </div>

                            <div className="bg-white rounded-xl shadow-sm p-6 flex flex-col justify-center min-h-[300px]">
                                {!selectedTech ? <div className="text-center text-slate-400">เลือก PST เพื่อเริ่มงาน</div> : (
                                    <div>
                                        <h3 className="text-2xl font-bold text-center mb-6">{selectedTech.name}</h3>
                                        {selectedTech.status === 'idle' ? (
                                            <div className="space-y-4">
                                                <input type="text" value={jobInput} onChange={e => setJobInput(e.target.value)} placeholder="Job No. (RO)" className="w-full p-3 border rounded-lg text-lg focus:ring-2 focus:ring-blue-500 outline-none" autoFocus />
                                                <div className="flex gap-2 items-center">
                                                    <input type="number" step="0.1" value={stdTimeInput} onChange={e => setStdTimeInput(e.target.value)} placeholder="Std Time (ชม.)" className="w-full p-3 border rounded-lg text-lg outline-none" />
                                                </div>
                                                <select value={partnerId} onChange={e => setPartnerId(e.target.value)} className="w-full p-3 border rounded-lg bg-blue-50 text-blue-800">
                                                    <option value="">-- ทำงานคนเดียว --</option>
                                                    {idleTechs.map(t => <option key={t.id} value={t.id}>+ {t.name}</option>)}
                                                </select>
                                                <button onClick={handleStartJob} disabled={!jobInput.trim()} className="w-full bg-blue-600 text-white py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 mt-2 disabled:bg-slate-300"><Icons.Play/> เริ่มงาน</button>
                                            </div>
                                        ) : (
                                            <div className="space-y-6">
                                                <div className="bg-blue-50 rounded-xl p-6 text-center border border-blue-100">
                                                    <div className="text-sm text-slate-500">JOB NO.</div>
                                                    <div className="text-2xl font-bold mb-4">{selectedTech.currentJob}</div>
                                                    <div className="text-5xl font-mono font-bold text-blue-700 tracking-wider mb-2">{getElapsed(selectedTech.startTime)}</div>
                                                    {selectedTech.stdTime > 0 && <div className="text-sm text-slate-500">Std: {selectedTech.stdTime} hr</div>}
                                                </div>
                                                <button onClick={handleStopJob} className="w-full border-2 border-red-500 text-red-500 py-4 rounded-xl text-lg font-bold flex items-center justify-center gap-2 hover:bg-red-50"><Icons.Square/> จบงาน</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'history' && (
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div className="p-4 border-b flex justify-between">
                                <h2 className="font-bold flex items-center gap-2"><span className="text-green-500"><Icons.History/></span> ประวัติงาน</h2>
                                {workLogs.length > 0 && <button onClick={clearLogs} className="text-red-400 text-sm flex items-center gap-1"><Icons.Trash2/> ล้าง</button>}
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">Date</th><th className="p-4">Tech</th><th className="p-4">Job</th><th className="p-4">Time</th><th className="p-4">Eff.</th></tr></thead>
                                    <tbody className="divide-y">
                                        {workLogs.map(log => (
                                            <tr key={log.id}>
                                                <td className="p-4 text-xs text-slate-400">{log.date}</td>
                                                <td className="p-4 font-bold">{log.techName}</td>
                                                <td className="p-4 text-blue-600">{log.jobNo}</td>
                                                <td className="p-4">{log.durationText}</td>
                                                <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${log.efficiency >= 100 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{log.efficiency}%</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {activeTab === 'dashboard' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white p-6 rounded-xl shadow-sm"><div className="text-slate-500 text-sm">Jobs Done</div><div className="text-3xl font-bold text-blue-600">{workLogs.length}</div></div>
                                <div className="bg-white p-6 rounded-xl shadow-sm"><div className="text-slate-500 text-sm">Avg Efficiency</div><div className="text-3xl font-bold text-purple-600">{workLogs.length ? Math.round(workLogs.reduce((a,b)=>a+b.efficiency,0)/workLogs.length) : 0}%</div></div>
                                <div className="bg-white p-6 rounded-xl shadow-sm"><div className="text-slate-500 text-sm">Sold Hours</div><div className="text-3xl font-bold text-green-600">{workLogs.reduce((a,b)=>a+(b.stdTime||0),0).toFixed(1)}</div></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TechnicianTimeTracker />);
    </script>
</body>
</html>